name: Deploy to EC2

on:
  push:
    branches:
      - main
  # Allows manual trigger from GitHub Actions tab
  workflow_dispatch:

env:
  APP_NAME: nestjs-api
  APP_DIR: /home/ubuntu/apps/nestjs-api
  DOCKER_COMPOSE_VERSION: "2.24.0"

jobs:
  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm run test

  deploy:
    name: ğŸš€ Deploy to EC2
    runs-on: ubuntu-latest
    needs: test
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            set -e  # Exit on any error
            
            echo "ğŸš€ Starting deployment..."
            echo "Timestamp: $(date)"
            
            # Navigate to app directory
            cd ${{ env.APP_DIR }}
            
            # Stash any local changes (if any)
            git stash || true
            
            # Pull latest changes
            echo "ğŸ“¥ Pulling latest changes from main..."
            git fetch origin main
            git reset --hard origin/main
            
            # Create/Update .env file from secrets
            echo "ğŸ“ Updating environment variables..."
            cat > .env << 'EOF'
            ${{ secrets.ENV_FILE }}
            EOF
            
            # Validate .env file was created
            if [ ! -f .env ]; then
              echo "âŒ Error: .env file was not created!"
              exit 1
            fi
            
            echo "âœ… Environment file updated"
            
            # Backup current container (in case of rollback)
            echo "ğŸ’¾ Creating backup of current deployment..."
            BACKUP_IMAGE="nestjs-api-backup-$(date +%Y%m%d-%H%M%S)"
            docker tag nestjs-api:latest "$BACKUP_IMAGE" 2>/dev/null || echo "No previous image to backup"
            
            # Stop current containers
            echo "ğŸ›‘ Stopping current containers..."
            docker compose down
            
            # Build new image
            echo "ğŸ”¨ Building new Docker image..."
            docker compose build --no-cache
            
            # Start containers
            echo "ğŸš€ Starting containers..."
            docker compose up -d
            
            # Wait for container to start
            echo "â³ Waiting for container to initialize..."
            sleep 15
            
            # Check if container is running
            if ! docker compose ps | grep -q "Up"; then
              echo "âŒ Container failed to start!"
              echo "ğŸ“‹ Container logs:"
              docker compose logs --tail=50
              exit 1
            fi
            
            # Health check with retries
            echo "ğŸ¥ Running health checks..."
            MAX_RETRIES=12
            RETRY_COUNT=0
            HEALTH_CHECK_URL="http://localhost:3001/api/health"
            
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if curl -f -s "$HEALTH_CHECK_URL" > /dev/null 2>&1; then
                echo "âœ… Health check passed!"
                HEALTH_RESPONSE=$(curl -s "$HEALTH_CHECK_URL")
                echo "Health check response: $HEALTH_RESPONSE"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                echo "â³ Health check attempt $RETRY_COUNT/$MAX_RETRIES failed, waiting 5s..."
                sleep 5
              fi
            done
            
            if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
              echo "âŒ Health check failed after $MAX_RETRIES attempts!"
              echo "ğŸ“‹ Container logs:"
              docker compose logs --tail=100
              echo "ğŸ”„ Rolling back to previous version..."
              docker compose down
              if docker images | grep -q "$BACKUP_IMAGE"; then
                docker tag "$BACKUP_IMAGE" nestjs-api:latest
                docker compose up -d
              fi
              exit 1
            fi
            
            # Clean up old images (keep last 3)
            echo "ğŸ§¹ Cleaning up old images..."
            docker image prune -f
            
            # Clean up old backup images (keep last 3)
            docker images | grep nestjs-api-backup | awk '{print $3}' | tail -n +4 | xargs -r docker rmi -f 2>/dev/null || true
            
            # Show container status
            echo "ğŸ“Š Container status:"
            docker compose ps
            
            # Show resource usage
            echo "ğŸ’» Resource usage:"
            docker stats --no-stream
            
            echo "âœ… Deployment completed successfully!"
            echo "ğŸ‰ Application is running at http://${{ secrets.EC2_HOST }}/api"

      - name: Deployment Status
        if: success()
        run: echo "âœ… Deployment completed successfully!"

      - name: Deployment Failed
        if: failure()
        run: echo "âŒ Deployment failed. Check the logs above."
